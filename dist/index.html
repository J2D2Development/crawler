<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Crawler</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="styles.css" />
            <script src="https://unpkg.com/vue"></script>
            <script src="/socket.io/socket.io.js"></script>
            <script>
                function init() {
                    var socket = io('http://localhost');
        
                    var app = new Vue({
                        el: '#crawl-app',
                        data: {
                            crawlStatus: 'Ready',
                            crawlResults: [],
                            crawlComplete: '',
                            crawlFilter: '',
                            loaded: false
                        },
                        methods: {
                            startCrawl
                        },
                        mounted: function() {
                            this.loaded = true;
                            console.log('mounted!', this.loaded);
                        }
                    });
        
                    function startCrawl() {
                        app.crawlResults = [];
                        socket.emit('crawl-start', { 
                            start: true, 
                            filter: app.crawlFilter 
                        });
                        app.crawlStatus = 'Running...';
                    }
        
                    socket.on('crawl-ready', function(data) {
                        app.crawlStatus = 'Ready!';
                    });
        
                    socket.on('crawl-data', function(data) {
                        app.crawlResults.push(data);
                    });
        
                    socket.on('crawl-complete', function(data) {
                        app.crawlComplete = data;
                        socket.disconnect();
                    });
        
                    socket.on('crawl-error', function(data) {
                        console.log('error passed:', data);
                        app.crawlStatus = `Error ${data.msg}`;
                    });
        
                    //if we don't disconnect after each crawl, data events duplicate
                    socket.on('disconnect', function() {
                        socket.open();
                    });
                }
        
                window.addEventListener('DOMContentLoaded', init);
            </script>
    </head>
    <body>
        <!--[if lt IE 9]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <div class="dash-wrapper_outer">
                <section class="menu-left_wrapper">
                <nav class="menu-left">
                  <h1>
                    Mimics Crawler
                    <i class="fa fa-times mobile abs-right" id="mobile-menu-close"></i>
                  </h1>
                  <ul>
                    <li>
                      <a href="#" class="active">
                        <i class="fa fa-2x fa-pie-chart" aria-hidden="true"></i>
                        <span>Dashboard</span>
                      </a>
                    </li>
                    <li>
                      <a>
                      <i class="fa fa-2x fa-cogs" aria-hidden="true"></i>
                      <span>Actions</span>
                      </a>
                    </li>
                    <li>
                      <a>
                      <i class="fa fa-2x fa-user-circle-o" aria-hidden="true"></i>
                      <span>Profile</span>
                      </a>
                    </li>
                    <li>
                      <a>
                      <div class="notifications notice-active">
                        5
                      </div>
                      <i class="fa fa-2x fa-bell-o" aria-hidden="true"></i>
                      <span>Notifications</span>
                      </a>
                    </li>
                  </ul>
                  <div class="nav-bg-img"></div>
                </nav>
                </section>
                <section class="main">
                  <nav class="menu-top">
                    <div style="display:flex;align-items:center;padding-left:3px;">
                      <i class="fa fa-2x fa-bars mobile" id="mobile-menu-open" aria-hidden="true"></i>
                      <h1 id="current-route-title">Dashboard</h1>
                    </div>
                    <ul>
                      <li>
                        <i class="fa fa-search" aria-hidden="true"></i>
                      </li>
                      <li>
                        <i class="fa fa-sign-out" aria-hidden="true"></i>
              
                      </li>
                    </ul>
                  </nav>
                  <div class="dash-wrapper_inner">
                  <div class="card">
                    <h1>System Status</h1>
                    <span>Current Info</span>
                    <ul>
                      <li>Last Crawl: xx</li>
                      <li>Next Scheduled: xx</li>
                    </ul>
                  </div>
                  <div class="card">
                        <div id="crawl-app">
                                <div v-if="!loaded">Loading...</div>
                                <div v-else>
                                    <div>{{crawlStatus}}</div>
                                    <select v-model="crawlFilter">
                                        <option value="" disabled>Choose Category to crawl</option>
                                        <option value="test">Test</option>
                                        <option value="">All</option>
                                        <option value="Accounting">Accounting</option>
                                        <option value="Banking">Banking</option>
                                    </select>
                                    <button v-on:click="startCrawl">Push me to start process</button>
                                    <div>
                                        <transition-group name="fade" tag="ul" class="crawl-results">
                                            <li v-for="(result, index) in crawlResults" v-bind:key="index">
                                                {{result.url}}: {{result.success}}
                                            </li>
                                        </transition-group>
                                    </div>
                                    <div v-if="crawlComplete">
                                        <h2>Crawl Complete</h2>
                                        {{crawlComplete.successes}} crawled.<br />
                                        {{crawlComplete.failures}} failed.
                                    </div>
                                </div>
                            </div>
                    <!-- <h1>Running Processes</h1>
                    <span>Current Actions</span>
                    <ul>
                      <li>None</li>
                    </ul> -->
                  </div>
                    <div class="card">
                    <h1>Details</h1>
                    <span>Real Time Tracking</span>
                      <div>Charts - static stats on last crawl and overall if no running, live updates (rxjs?) if currently running</div>
                  </div>
                  </div>
                </section>
                
              </div>
    </body>

    <script>
        const title = document.getElementById('current-route-title');
        const leftMenuItems = Array.from(document.querySelectorAll('.menu-left a'));
        const menuHandle = document.querySelector('section.menu-left_wrapper');
        const mobileMenuOpen = document.querySelector('#mobile-menu-open');
        const mobileMenuClose = document.querySelector('#mobile-menu-close');

        leftMenuItems.forEach((item, index, arr) => {
        item.addEventListener('click', function() {
            arr.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            title.innerText = item.querySelector('span').innerText;
        });
        });

        mobileMenuOpen.addEventListener('click', () => {
        menuHandle.classList.add('mobile-menu-active');
        });
        mobileMenuClose.addEventListener('click', () => {
        menuHandle.classList.remove('mobile-menu-active');
        })
    </script>
</html>